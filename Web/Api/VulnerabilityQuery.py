from django.http import JsonResponse
from Web.WebClassCongregation import UserInfo,ActiveScanList,MedusaQuery
from ClassCongregation import ScanInformation,ErrorLog,PortDB
import json
from Web.Workbench.LogRelated import UserOperationLogRecord,RequestLogRecord

"""active_scan_list_query
{
	"token": "XXXXX"
}
"""

def ActiveScanListQuery(request):#主动扫描列表查询
    RequestLogRecord(request, request_api="active_scan_list_query")
    if request.method == "POST":
        try:
            UserToken=json.loads(request.body)["token"]
            Uid = UserInfo().QueryUidWithToken(UserToken)  # 如果登录成功后就来查询用户名
            if Uid!=None: # 查到了UID
                UserOperationLogRecord(request, request_api="active_scan_list_query", uid=Uid)
                ActiveScanListQueryResult=ActiveScanList().Query(uid=Uid)
                if ActiveScanListQueryResult!=None:
                    return JsonResponse({'message':ActiveScanListQueryResult, 'code': 200, })
                else:
                    return JsonResponse({'message': '数据库出问题了🐈', 'code': 404, })
            else:
                return JsonResponse({'message': "小宝贝这是非法查询哦(๑•̀ㅂ•́)و✧", 'code': 403, })
        except Exception as e:
            ErrorLog().Write("Web_Api_VulnerabilityQuery_ActiveScanListQuery(def)", e)
            return JsonResponse({'message': '莎酱被玩坏啦(>^ω^<)喵', 'code': 169, })
    else:
        return JsonResponse({'message': '请使用Post请求', 'code': 500, })



"""scan_information_query
{
	"token": "XXXXX",
	"active_scan_id":"1"
}
"""
def ScanInformationQuery(request):#查询关系表
    RequestLogRecord(request, request_api="scan_information_query")
    if request.method == "POST":
        try:
            UserToken=json.loads(request.body)["token"]
            ActiveScanId=json.loads(request.body)["active_scan_id"]
            Uid = UserInfo().QueryUidWithToken(UserToken)  # 如果登录成功后就来查询用户名
            if Uid!=None: # 查到了UID
                UserOperationLogRecord(request, request_api="scan_information_query", uid=Uid)
                MedusaQueryResult=ScanInformation().Query(uid=Uid,active_scan_id=ActiveScanId)
                if MedusaQueryResult!=None:
                    return JsonResponse({'message':MedusaQueryResult, 'code': 200, })
                else:
                    return JsonResponse({'message': '数据库炸了BOOM~🐈', 'code': 404, })
            else:
                return JsonResponse({'message': "小宝贝这是非法查询哦(๑•̀ㅂ•́)و✧", 'code': 403, })
        except Exception as e:
            ErrorLog().Write("Web_Api_VulnerabilityQuery_ScanInformationQuery(def)", e)
            return JsonResponse({'message': '莎酱被玩坏啦ヽ(･ω･´ﾒ)', 'code': 169, })
    else:
        return JsonResponse({'message': '请使用Post请求', 'code': 500, })

"""medusa_query
{
	"token": "XXXXX",
	"scan_info_id":"1"
}
"""
def MedusaValueQuery(request):#查询单个漏洞
    RequestLogRecord(request, request_api="medusa_query")
    if request.method == "POST":
        try:
            UserToken=json.loads(request.body)["token"]
            ScanInfoId=json.loads(request.body)["scan_info_id"]
            Uid = UserInfo().QueryUidWithToken(UserToken)  # 如果登录成功后就来查询用户名
            if Uid!=None: # 查到了UID
                UserOperationLogRecord(request, request_api="medusa_query", uid=Uid)
                MedusaQueryResult=MedusaQuery().Query(uid=Uid,scan_info_id=ScanInfoId)
                if MedusaQueryResult!=None:
                    return JsonResponse({'message':MedusaQueryResult, 'code': 200, })
                else:
                    return JsonResponse({'message': '数据库GG了🐈', 'code': 404, })
            else:
                return JsonResponse({'message': "小宝贝这是非法查询哦(๑•̀ㅂ•́)و✧", 'code': 403, })
        except Exception as e:
            ErrorLog().Write("Web_Api_VulnerabilityQuery_MedusaValueQuery(def)", e)
            return JsonResponse({'message': '莎酱被玩坏啦ヾ(=･ω･=)o', 'code': 169, })
    else:
        return JsonResponse({'message': '请使用Post请求', 'code': 500, })

"""actively_scan_port_information
{
	"token": "XXXXX",
	"active_scan_id":"1"
}
"""
def ActivelyScanPortInformation(request):#查询主动扫描中扫描端口的信息
    RequestLogRecord(request, request_api="actively_scan_port_information")
    if request.method == "POST":
        try:
            UserToken=json.loads(request.body)["token"]
            ActiveScanId=json.loads(request.body)["active_scan_id"]
            Uid = UserInfo().QueryUidWithToken(UserToken)  # 如果登录成功后就来查询用户名
            if Uid!=None: # 查到了UID
                UserOperationLogRecord(request, request_api="actively_scan_port_information", uid=Uid)
                PortInformationResult=PortDB().Query(uid=Uid,active_scan_id=ActiveScanId)
                if PortInformationResult!=None:
                    return JsonResponse({'message':PortInformationResult, 'code': 200, })
                else:
                    return JsonResponse({'message': '宝贝没有数据哦🐈', 'code': 404, })
            else:
                return JsonResponse({'message': "嘿~宝贝这是非法查询哦(๑•̀ㅂ•́)و✧", 'code': 403, })
        except Exception as e:
            ErrorLog().Write("Web_Api_VulnerabilityQuery_ScanInformationQuery(def)", e)
            return JsonResponse({'message': '莎酱被玩坏啦ヽ(･ω･´ﾒ)', 'code': 169, })
    else:
        return JsonResponse({'message': '请使用Post请求', 'code': 500, })
