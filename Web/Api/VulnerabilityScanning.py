import json
import time
from django.http import JsonResponse
from Web.WebClassCongregation import UserInfo,ActiveScanList
from Web.Api.Tasks import MedusaScan

#接收数据样式
'''
{
	"url": "www.ascotbe.com",
	"token": "5Lkqen4wwWzHlgJwkM55AJIjbmDCWoi07FAV1bIsNemYHdF0zC2fJ51eD2PY5lMFBZ8GqArOBV5rSmMpMP8n1tXXjNOPXR4TBI26VQhHlFZTkryENw37LnPtQiLuTRpspue0L9KhCbNzRd81JphHeLZvfG9UedvSzvyb83GmGhvnLAim7JwudlmIcYagE2ljxYivEIm0EraPWR2sQGGxHQ0Z3upQ0GLG31HBdxHCw0DH5BoyzzMN1GdKI7",
	"threads": 200,
	"module": "all",
	"header": "None",
	"proxy": "127.0.0.1:8080"
}
'''

def Scan(request):
    if request.method == "POST":
        try:
            ReceiveData=json.loads(request.body)
            ScanUrl=ReceiveData["url"]
            ScanToken= ReceiveData["token"]
            ScanModule = ReceiveData["module"]
            ScanThreads = ReceiveData["threads"]
            ScanAgentHeader = ReceiveData["header"]
            ScanProxy = ReceiveData["proxy"]
            if type(ScanThreads)==int:#判断类型
                TokenQueryReturnValue=UserInfo().TokenAuthentication(token=ScanToken)
                if TokenQueryReturnValue:#如果Token存在
                    UserName=UserInfo().QueryUserNameWithToken(ScanToken)#如果登录成功后就来查询用户名
                    if UserName!=None:
                        ActiveScanList().Write(uid=UserName,url=ScanUrl,proxy=ScanProxy,status=0,module=ScanModule,threads=ScanThreads)#写入用户关系表
                        #MedusaScan.delay(ScanUrl,ScanToken,ScanModule,ScanThreads,ScanAgentHeader)#调用扫描处理函数
                        return JsonResponse({'message': '任务下发成功', 'code': 200, })
                    else:
                        return JsonResponse({'message': UserName, 'code': 404, })
                        #return JsonResponse({'message': '诶诶诶诶？？？怎么会查不到用户名呢？？？？', 'code': 404, })
                else:
                    return JsonResponse({'message': '请登录获取令牌秘钥~', 'code': 404, })
            else:
                return JsonResponse({'message': '类型错误！', 'code': 500, })

        except:
            return JsonResponse({'message': '请求不合法！', 'code': 500, })
    else:
        return JsonResponse({'message': '请使用Get请求', 'code': 500, })

