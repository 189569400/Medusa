# !/usr/bin/python env
# -*- coding:utf-8 -*-
import json
import ClassCongregation
import requests
import time

def GithubMonitor():
    try:
        headers = {
            'Accept-Encoding': 'gzip, deflate',
            'Accept': '*/*',
            'User-Agent': "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/79.0.3945.117 Safari/537.36",
        }
        GitCveApi=requests.get("https://api.github.com/search/repositories?q=CVE-&sort=updated&order=desc",headers=headers, timeout=10)
        con=GitCveApi.text
        GitCveApiJson=json.loads(con)
        DataExtraction=GitCveApiJson["items"]
        for i in DataExtraction:
            GithubCveSekect=ClassCongregation.GithubCveApi(i).Judgment()#先查询数据库
            if GithubCveSekect:
                ClassCongregation.GithubCveApi(i).Update(str(int(time.time())))#如果存在就更新
            else:
                ClassCongregation.GithubCveApi(i).Write()#如果不存在就写入
                #写完后对数据进行分析

    except Exception as e:
        ClassCongregation.ErrorLog().Write("Web_CommonVulnerabilityDetection_GithubMonitor(def)", e)

